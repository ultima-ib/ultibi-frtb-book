<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Ultibi Python FRTB Cube User Guide</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="ultibi python developer&#x27;s user guide. PivotUI, Cube, FRTB.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="tabbed-code-blocks.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="quickstart/quickstart.html"><strong aria-hidden="true">2.</strong> Quickstart</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="quickstart/ui_quick.html"><strong aria-hidden="true">2.1.</strong> with UI</a></li><li class="chapter-item expanded "><a href="quickstart/fx.html"><strong aria-hidden="true">2.2.</strong> FRTB FX</a></li></ol></li><li class="chapter-item expanded "><a href="inputs/inputs_intro.html"><strong aria-hidden="true">3.</strong> Input, DataSource and DataSet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="inputs/datasources.html"><strong aria-hidden="true">3.1.</strong> Data Sources</a></li><li class="chapter-item expanded "><a href="inputs/input.html"><strong aria-hidden="true">3.2.</strong> Config file</a></li><li class="chapter-item expanded "><a href="inputs/format.html"><strong aria-hidden="true">3.3.</strong> FRTB Input Format</a></li><li class="chapter-item expanded "><a href="inputs/bespoke_measures.html"><strong aria-hidden="true">3.4.</strong> Define your own Measures</a></li></ol></li><li class="chapter-item expanded "><a href="calculation/calc_intro.html"><strong aria-hidden="true">4.</strong> Calculation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="calculation/weights.html"><strong aria-hidden="true">4.1.</strong> Prepare (FRTB Assign Weights)</a></li><li class="chapter-item expanded "><a href="calculation/calculate.html"><strong aria-hidden="true">4.2.</strong> Calculation (FRTB Capital)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="calculation/frtb_measures.html"><strong aria-hidden="true">4.2.1.</strong> FRTB Supported measures</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="whatif.html"><strong aria-hidden="true">5.</strong> WhatIf</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="filters.html"><strong aria-hidden="true">5.1.</strong> Filters</a></li><li class="chapter-item expanded "><a href="override.html"><strong aria-hidden="true">5.2.</strong> Overrides</a></li><li class="chapter-item expanded "><a href="add_row.html"><strong aria-hidden="true">5.3.</strong> Add Rows(Trades)</a></li><li class="chapter-item expanded "><a href="calc_params.html"><strong aria-hidden="true">5.4.</strong> Calc Params and Params Sets</a></li></ol></li><li class="chapter-item expanded "><a href="ui.html"><strong aria-hidden="true">6.</strong> UI</a></li><li class="chapter-item expanded "><a href="performance.html"><strong aria-hidden="true">7.</strong> Performance</a></li><li class="chapter-item expanded "><a href="feedback.html"><strong aria-hidden="true">8.</strong> Contacts and Feedback</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ultibi Python FRTB Cube User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p><strong><code>ultibi</code></strong> is a free python library by <strong><a href="https://github.com/ultima-ib/ultima">Ultima</a></strong>. <strong><code>ultibi</code></strong> is a framework for building Pivot Tables and Cubes, to display and drill through the key metrics for your data.</p>
<p>This userguide will provide examples of the functionality. We pick - <strong><a href="https://en.wikipedia.org/wiki/Fundamental_Review_of_the_Trading_Book">Fundamental Review of the Trading Book's Standardised Approach</a></strong> to serve as a great usecase example.</p>
<h1 id="why-to-use-ultibi"><a class="header" href="#why-to-use-ultibi">Why to use <code>ultibi</code></a></h1>
<ul>
<li>
<p>You can breakdown and drillthrough your computation</p>
</li>
<li>
<p>Everything you need for analysis: <a href="./filters.html">Filtering</a>, <a href="./override.html">Overriding</a>, <a href="./add_row.html">Adding Trades</a> and so on.</p>
</li>
<li>
<p>Blazingly <a href="./performace.html">fast</a>.</p>
</li>
</ul>
<h1 id="why-to-use-ultibi-for-frtb"><a class="header" href="#why-to-use-ultibi-for-frtb">Why to use <code>ultibi</code> for <strong>FRTB</strong></a></h1>
<ul>
<li>
<p>The calculation goes as per <strong><a href="https://www.bis.org/bcbs/publ/d457.pdf">FRTB SA Paper</a></strong> (Note: <code>ultibi</code> is not (yet) certified by ISDA. Always check the output against your own interpretation of the regulation) and aims to be fully compliant(although not certified). <strong><code>ultibi</code></strong> supports <strong><a href="https://www.eba.europa.eu/regulation-and-policy/single-rulebook/interactive-single-rulebook/108255">CRR2</a></strong> parameter set out of the box. Switch between the two is as easy as setting <code>jurisdiction</code> to <code>CRR2</code> or <code>BCBS</code>.</p>
</li>
<li>
<p><code>ultibi</code> is very flexible and allows you to override any of the prescribed parameters (such as <code>girr_delta_rho_infl_base_low</code>) via <code>calc_params</code> argument. This essentually means that you can define your own parameter sets as per any regulatory requirements (eg non BCBS/CRR2). This also means that you can <strong>stress test</strong> against changes in the values of the prescribed (aka hard coded by ISDA) parameters.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>If you are downloading from a software repository</p>
<pre><code class="language-console">pip install ultibi
</code></pre>
<p>or if you have a .whl file</p>
<pre><code class="language-console">pip install *.whl
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tldr"><a class="header" href="#tldr">TL;DR</a></h1>
<p>Although it is strongly advised to read all the chapters, this chapter consists of reproducible examples if you are looking to get up and running instantaneously.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="with-ui"><a class="header" href="#with-ui">with UI</a></h1>
<p>To spin up the Cube/Pivot UI</p>
<pre><code class="language-python">import ultibi as ul
import polars as pl
import os

os.environ[&quot;RUST_LOG&quot;] = &quot;info&quot;  # enable logs
os.environ[&quot;ADDRESS&quot;] = &quot;0.0.0.0:8000&quot;  # host on this address

# Read Data
# for more details: https://pola-rs.github.io/polars/py-polars/html/reference/api/polars.read_csv.html
df = pl.read_csv(&quot;data/titanic.csv&quot;)

# Convert it into an Ultibi DataSet
ds = ul.DataSet.from_frame(df)

# By default (might change in the future)
# Fields are Utf8 (non numerics) and integers, but you can configure it
# through the config. See `Input and Data Sources` section.
# Measures are numeric columns.
ds.ui()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fx-example"><a class="header" href="#fx-example">FX Example</a></h1>
<pre><code class="language-python">import polars as pl
import ultibi as ul

pl.Config.set_tbl_rows(100)
pl.Config.set_tbl_cols(14)

# First, let's mock up a portfolio of 15 trades
# Note: we will ask ultibi to assign risk weight for us as per the regulation
# As such, we need to provide all the columns required for weights assignments,
# even if they are not used.
# fmt: off
data = {
# Optional but useful column. We will aggregate at the level of &quot;Group&quot;
&quot;Group&quot;: [&quot;Ultima&quot;]*15,
# Delta represents both Delta and Curvature risk. Vega is for Vega only
&quot;RiskCategory&quot;:	[&quot;Delta&quot;,&quot;Delta&quot;,&quot;Delta&quot;,&quot;Delta&quot;,&quot;Vega&quot;,&quot;Vega&quot;,&quot;Vega&quot;,&quot;Vega&quot;,
                 &quot;Delta&quot;,&quot;Delta&quot;,&quot;Delta&quot;,&quot;Delta&quot;,&quot;Delta&quot;,&quot;Delta&quot;,&quot;Delta&quot;],
&quot;RiskClass&quot;: [&quot;FX&quot;,	&quot;FX&quot;, &quot;FX&quot;,	&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,&quot;FX&quot;,
              &quot;FX&quot;,&quot;FX&quot;],
# FX Risk Factor must be of CCY1/CCY2 format
&quot;RiskFactor&quot;:[&quot;GBPUSD&quot;,&quot;BRLUSD&quot;,&quot;BRLUSD&quot;,&quot;JPYEUR&quot;,&quot;GBPUSD&quot;,&quot;GBPUSD&quot;,&quot;THOUSD&quot;,&quot;JPYEUR&quot;,&quot;EUREUR&quot;,&quot;EURUSD&quot;,&quot;GBPEUR&quot;,&quot;GBPUSD&quot;,&quot;EURUSD&quot;,&quot;AZNUSD&quot;,&quot;EURUSD&quot;],
# We leave it as none because ultibi fills nans on this column with RiskFactor for FX
&quot;BucketBCBS&quot;: [None]*15,															
&quot;BucketCRR2&quot;: [None]*15,
# RiskFactorType is not relevant to FX, but we still need to provide it 
&quot;RiskFactorType&quot;: [&quot;&quot;]*15,
&quot;CreditQuality&quot;: [&quot;&quot;]*15,	
# Cob and MaturityDate is not relevant to FX, but we still need to provide it 
&quot;COB&quot;: [&quot;2023-01-30&quot;]*15,
&quot;MaturityDate&quot;: [&quot;2023-01-30&quot;]*15,	
# These are our sensitivities
&quot;PnL_Up&quot;:[1000.0,1000,1000,1000,None,None,None,None,None,None,None,None,None,None,None],										
&quot;PnL_Down&quot;:[-1000.0,-1000,-1000,-1000,None,None,None,None,None,None,None,None,None,None,None],										
&quot;SensitivitySpot&quot;:[123000,	123000,	123000,	123000, None,None,None,None,100,5,15,10,5,
                    -13.5,100],
&quot;Sensitivity_05Y&quot;:[None,None,None,None,5000,5000,1000,None,None,None,None,None,None,None,None],							
&quot;Sensitivity_1Y&quot;:[None,None,None,None,5000,5000,None,1000,None,None,None,None,None,None,None],								
&quot;Sensitivity_3Y&quot;: [None,None,None,None,5000,5000,None,1000,None,None,None,None,None,
                    None,None],
&quot;Sensitivity_5Y&quot;: [None,None,None,None,5000,5000,None,1000,None,None,None,None,None,
                    None,None],
&quot;Sensitivity_10Y&quot;: [None,None,None,None,5000,5000,None,1000,None,None,None,None,None,
                    None,None],
# 21.98
&quot;FxCurvDivEligibility&quot;:[True,True,None,None,None,None,None,None,None,None,None,None,None,None,None],
}	
# fmt: on
df = pl.DataFrame(data)

# Conver our frame into FRTB dataset, opting into sqrt 2 division as per 21.88
ds = ul.FRTBDataSet.from_frame(df, build_params={&quot;fx_sqrt2_div&quot;: &quot;true&quot;})
# This will add SensWeights and CurvatureWeight columns to our dataset
ds.prepare()

request = dict(
    measures=[
        [&quot;FX DeltaCharge Low&quot;, &quot;scalar&quot;],
        [&quot;FX DeltaCharge Medium&quot;, &quot;scalar&quot;],
        [&quot;FX DeltaCharge High&quot;, &quot;scalar&quot;],
        [&quot;FX VegaCharge Low&quot;, &quot;scalar&quot;],
        [&quot;FX VegaCharge Medium&quot;, &quot;scalar&quot;],
        [&quot;FX VegaCharge High&quot;, &quot;scalar&quot;],
        [&quot;FX CurvatureCharge Low&quot;, &quot;scalar&quot;],
        [&quot;FX CurvatureCharge Medium&quot;, &quot;scalar&quot;],
        [&quot;FX CurvatureCharge High&quot;, &quot;scalar&quot;],
    ],
    # Break down results by Group and BucketBCBS
    groupby=[&quot;Group&quot;, &quot;BucketBCBS&quot;],
    # Show totals for each Group (note in this example only 1)
    totals=True,
    # Hide rows where each result is 0
    hide_zeros=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        # Apply 21.98
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
    },
)

# Execute
result = ds.compute(request)
print(result)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="input-and-data-sources"><a class="header" href="#input-and-data-sources">Input and Data Sources</a></h1>
<p>Any calculation/function needs an input and our <code>ultibi DataSet</code> is no exception. In this chapter we go through various ways to feed data into <code>ultibi</code>, their pros and cons.</p>
<h2 id="ultima-dataset"><a class="header" href="#ultima-dataset">Ultima DataSet</a></h2>
<p>First step is to create a DataSet from your data. Your data could be your portfolio for example. Think of a DataSet as a DataFrame with some special pre defined functions (eg &quot;FX Delta Capital Charge&quot;).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="input-and-data-sources-1"><a class="header" href="#input-and-data-sources-1">Input and Data Sources</a></h1>
<h2 id="in-memory"><a class="header" href="#in-memory">In Memory</a></h2>
<p>If your data fits into process memory - use that. It's fast.</p>
<pre><code class="language-python">import ultibi as ul
import polars as pl

in_mem_frame = pl.read_csv(
    &quot;./data/frtb/Delta.csv&quot;, dtypes={&quot;SensitivitySpot&quot;: pl.Float64}
)
dsource = ul.DataSource.inmemory(in_mem_frame)
ds = ul.DataSet.from_source(dsource)
ds.prepare()  # .prepare() is only relevant to FRTB dataset currently

ds.ui()
</code></pre>
<p>Same would be achieved with a <code>.from_frame()</code> shortcut.</p>
<p>Your data must be a <a href="https://pola-rs.github.io/polars-book/user-guide/">polars</a> <a href="https://pola-rs.github.io/polars/py-polars/html/reference/dataframe/index.html">Dataframe</a>. You can either do this yourself(using any of the countless <a href="https://pola-rs.github.io/polars-book/user-guide/howcani/io/csv.html">IO</a> operations supported, or using a <a href="inputs/./input.html">config</a>. Note polars also supports <a href="https://pola-rs.github.io/polars/py-polars/html/reference/api/polars.from_pandas.html">from_pandas</a> and <a href="https://pola-rs.github.io/polars/py-polars/html/reference/api/polars.from_arrow.html">from_arrow</a>) or use a <a href="inputs/datasources.html#data-source-config">config</a>.</p>
<pre><code class="language-python">{{#include ../examples/frtb_input.py:0:8}}
print(ds.frame(None))
</code></pre>
<h2 id="scan"><a class="header" href="#scan">Scan</a></h2>
<p>If you can't hold all your data in the process memory, you can sacrifise performance for a Scan.</p>
<pre><code class="language-python">import polars as pl
import ultibi as ul

# Note that the LazyFrame query must start with scan_
# and must've NOT been collected
scan = pl.scan_csv(&quot;./data/frtb/Delta.csv&quot;, dtypes={&quot;SensitivitySpot&quot;: pl.Float64})
dsource = ul.DataSource.scan(scan)
ds = ul.DataSet.from_source(dsource)

ds.ui()
</code></pre>
<p>Note:</p>
<ul>
<li>Naturally this option will be slower, because prior to computing your measures we will need to read the relevant bits of the data into the process memory, and if relevant, call .prepare().</li>
<li>Scanning involves serialisation of the Lazy Frame, and hence the python version of your <code>polars</code> lib must be aligned to what we expect. At the time of writing it has to be <code>&gt;=0.18.7</code>.</li>
</ul>
<h2 id="database---work-in-progress"><a class="header" href="#database---work-in-progress">DataBase - Work in Progress</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h2 id="data-source-config"><a class="header" href="#data-source-config">Data Source Config</a></h2>
<p>In principle, you are free to enrich this structure with as many columns as you want (for example Desk, Legal Entity etc). You can either do this manually or use <code>from_config</code>. Check out an example with explanations of each field: <a href="https://ultima-bi.s3.eu-west-2.amazonaws.com/frtb/datasource_config.toml">datasource_config.toml</a>.</p>
<pre><code class="language-python">import ultibi as ul

# You can set up a config and we will take care of
# castings, joins etc
ds = ul.FRTBDataSet.from_config_path(&quot;./data/frtb/datasource_config.toml&quot;)
print(ds.frame(None))
</code></pre>
<h2 id="validate-work-in-progress"><a class="header" href="#validate-work-in-progress">Validate (work in progress)</a></h2>
<p>If you are missing a required column you will get a runtime error during the execuiton of your request. Alternatively, call `.validate()`` on your dataset. It checks if every required column for every availiable calculation is present. Note: If you <strong>can</strong> guarantee your particular calculation would not require the missing columns you can proceed at your own risk!</p>
<pre><code class="language-python">import ultibi as ul

ds = ul.FRTBDataSet.from_config_path(&quot;./data/frtb/datasource_config.toml&quot;)
try:
    ds.validate()
except ul.NoDataError as e:
    print(
        &quot;One of key columns is missing. Be carefull if you wish to proceed &quot;
        &quot;without it. Error: &quot;,
        e,
    )
print(&quot;Complete&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="frtb-sa---input-format"><a class="header" href="#frtb-sa---input-format">FRTB SA - Input format</a></h1>
<p>In case of FRTB SA the <strong>input is your portfolio sensitivities at trade level</strong>. Currently expected format for the sensitivities is like this: <a href="https://ultima-bi.s3.eu-west-2.amazonaws.com/frtb/Delta.csv">Delta.csv</a>. This format is very similar to the industry standard <a href="https://www.isda.org/a/aBzTE/The-Future-of-Risk-Capital-and-Margin.pdf">CRIF</a>. Coming soon full CRIF support. As you can see, this file is your Sensitivities at Trade-RiskFactor-Tenor level.</p>
<p>In our examples we will also be using an optional <code>hierarchies</code> file <a href="https://ultima-bi.s3.eu-west-2.amazonaws.com/frtb/hms.csv">hms.csv</a>. Hierarchies simply define which <code>Book</code> belongs to where in terms of Business and/or Legal structure (eg which Desk or Legal Entity).</p>
<p>Finally, we need <a href="https://ultima-bi.s3.eu-west-2.amazonaws.com/frtb/TradeAttributes.csv">TradeAttributes.csv</a>. It is similar to our Delta Sensis but the data here is at Trade level only. Ie Notional, Product/Derivative Type, RRAO Flags etc etc.</p>
<h1 id="defenitions"><a class="header" href="#defenitions">Defenitions</a></h1>
<p>Note that the <strong><a href="https://www.bis.org/bcbs/publ/d457.pdf">FRTB SA Paper</a></strong> actually well defines what a &quot;RiskFactor&quot; is and the formulas for &quot;Sensitivities&quot;. See paragraphs <code>21.8-21.19</code> and <code>21.19-21.26</code> respectively.</p>
<h3 id="expected-columns-explanation---risk"><a class="header" href="#expected-columns-explanation---risk">Expected Columns Explanation - Risk</a></h3>
<p>Table below will outline which columns are expected, the useage and meaning behind them. This table might get outdated. Always check <code>Delta.csv</code>.</p>
<div class="table-wrapper"><table><thead><tr><th>ColumnName</th><th>Expected for Weights Assignments</th><th>Expected for Calculation (past weights/scailing assignments)</th><th>Restrictions on values</th><th>Where used</th><th>Explanation</th></tr></thead><tbody>
<tr><td>COB</td><td>Y</td><td>N</td><td>N</td><td>Used with MaturityDate to assign DRC Scailing Factor</td><td></td></tr>
<tr><td>TradeId</td><td>N</td><td>Y</td><td>N</td><td>RRAO</td><td></td></tr>
<tr><td>RiskCategory</td><td>Y</td><td>Y</td><td>Delta or Vega</td><td>All Risk Calculations</td><td>Note: Curvature goes under Delta</td></tr>
<tr><td>RiskClass</td><td>Y</td><td>Y</td><td>DRC_Sec_nonCTP/DRC_nonSec/CSR_Sec_nonCTP/Commodity/CSR_Sec_CTP/CSR_nonSec/Equity/FX/GIRR</td><td>All Risk Calculations(except RRAO)</td><td></td></tr>
<tr><td>RiskFactor</td><td>Y</td><td>Y</td><td></td><td>All Risk Calculations(except RRAO)</td><td>Different meaning depending on RiskClass. See Delta.csv for correct value for your particular RiskClass. Note: for FX convention used XXXCCY where CCY is your reporting currency. Parameter reporting_ccy will filter out all lines where CCY doesn't match it's value. For jurisdiction BCBS XXXUSD only will be used (unless overriden with reporting_ccy), and similarly XXXEUR for CRR2.</td></tr>
<tr><td>RiskFactorType</td><td>Y</td><td>Y</td><td>See Delta.csv</td><td>All Risk Calculations(except RRAO)</td><td>Note: Different meaning depending on RiskClass. See Delta.csv for correct value for your particular RiskClass.</td></tr>
<tr><td>CreditQuality</td><td></td><td>N</td><td></td><td>DRC nonSec and DRC Sec nonCTP</td><td>For DRC Sec nonCTP Joined with RiskFactorType with _ and then assigned via the table below. For DRC nonSec see respective table</td></tr>
<tr><td>MaturityDate</td><td>Y</td><td>N</td><td></td><td>Used with COB to assign DRC Scailing Factor</td><td></td></tr>
<tr><td>Tranche</td><td></td><td>Y</td><td></td><td>DRC_Sec_nonCTP</td><td></td></tr>
<tr><td>CommodityLocation</td><td></td><td>Y</td><td></td><td>Commodity Delta</td><td></td></tr>
<tr><td>GirrVegaUnderlyingMaturity</td><td></td><td>Y</td><td></td><td>GIRR Vega</td><td></td></tr>
<tr><td>BucketBCBS</td><td></td><td>Y</td><td>See Delta.csv</td><td>All Risk Calculations(except RRAO)</td><td>Be careful, refer to Delta.csv Note: For FX if not provided will be derived using RiskFactor</td></tr>
<tr><td>BucketCRR2</td><td></td><td>Y(if opt in CRR2)</td><td>See Delta.csv</td><td></td><td>Note: Present because some CSR buckets are different between BCBS and CRR2</td></tr>
<tr><td>GrossJTD</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>PnL_Up</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>PnL_Down</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>SensitivitySpot</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>Sensitivity_025Y</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>Sensitivity_05Y</td><td></td><td>Y</td><td></td><td></td><td>For Vega used as Option Maturity Tenor. For Delta as Risk Factor Tenor</td></tr>
<tr><td>Sensitivity_1Y</td><td></td><td>Y</td><td></td><td></td><td>For Vega used as Option Maturity Tenor. For Delta as Risk Factor Tenor</td></tr>
<tr><td>Sensitivity_2Y</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>Sensitivity_3Y</td><td></td><td>Y</td><td></td><td></td><td>For Vega used as Option Maturity Tenor. For Delta as Risk Factor Tenor</td></tr>
<tr><td>Sensitivity_5Y</td><td></td><td>Y</td><td></td><td></td><td>For Vega used as Option Maturity Tenor. For Delta as Risk Factor Tenor</td></tr>
<tr><td>Sensitivity_10Y</td><td></td><td>Y</td><td></td><td></td><td>For Vega used as Option Maturity Tenor. For Delta as Risk Factor Tenor</td></tr>
<tr><td>Sensitivity_15Y</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>Sensitivity_20Y</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>Sensitivity_30Y</td><td></td><td>Y</td><td></td><td></td><td></td></tr>
<tr><td>CoveredBondReducedWeight</td><td>Y(if you opted in via config)</td><td>N</td><td></td><td>Y or N</td><td></td></tr>
<tr><td>FxCurvDivEligibility</td><td></td><td>Y</td><td></td><td>Y or N</td><td></td></tr>
</tbody></table>
</div>
<h3 id="expected-columns-explanation---trade-attributes"><a class="header" href="#expected-columns-explanation---trade-attributes">Expected Columns Explanation - Trade attributes</a></h3>
<div class="table-wrapper"><table><thead><tr><th>ColumnName</th><th>Expected for Weights Assignments</th><th>Expected for Calculation (past weights/scailing assignments)</th><th>Restrictions on values</th><th>Where used</th><th>Explanation</th></tr></thead><tbody>
<tr><td>TradeId</td><td>N</td><td>Y</td><td>N</td><td>RRAO</td><td></td></tr>
<tr><td>BookId</td><td>N</td><td>N</td><td></td><td></td><td>Not required. We use it to join hms.csv</td></tr>
<tr><td>EXOTIC_RRAO</td><td>N</td><td>Y</td><td></td><td>RRAO</td><td></td></tr>
<tr><td>OTHER_RRAO</td><td>N</td><td>Y</td><td></td><td>RRAO</td><td></td></tr>
<tr><td>Notional</td><td>N</td><td>Y</td><td></td><td>RRAO</td><td></td></tr>
</tbody></table>
</div>
<h3 id="drc-sec-nonctp---creditqiality_riskfactortype-weights"><a class="header" href="#drc-sec-nonctp---creditqiality_riskfactortype-weights">DRC Sec nonCTP - CreditQiality+_+RiskFactorType Weights</a></h3>
<div class="table-wrapper"><table><thead><tr><th>CreditQuality+_+RiskFactorType</th><th>DRC Sec  nonCTP Weight</th></tr></thead><tbody>
<tr><td>AAA_SENIOR</td><td>1.2</td></tr>
<tr><td>AA+_SENIOR</td><td>1.2</td></tr>
<tr><td>AA_SENIOR</td><td>2</td></tr>
<tr><td>AA-_SENIOR</td><td>2.4</td></tr>
<tr><td>A+_SENIOR</td><td>3.2</td></tr>
<tr><td>A_SENIOR</td><td>4</td></tr>
<tr><td>A-_SENIOR</td><td>4.8</td></tr>
<tr><td>BBB+_SENIOR</td><td>6</td></tr>
<tr><td>BBB_SENIOR</td><td>7.2</td></tr>
<tr><td>BBB-_SENIOR</td><td>9.6</td></tr>
<tr><td>BB+_SENIOR</td><td>11.2</td></tr>
<tr><td>BB_SENIOR</td><td>12.8</td></tr>
<tr><td>BB-_SENIOR</td><td>16</td></tr>
<tr><td>B+_SENIOR</td><td>20</td></tr>
<tr><td>B_SENIOR</td><td>24.8</td></tr>
<tr><td>B-_SENIOR</td><td>30.4</td></tr>
<tr><td>CCC+_SENIOR</td><td>36.8</td></tr>
<tr><td>CCC_SENIOR</td><td>36.8</td></tr>
<tr><td>CCC-_SENIOR</td><td>36.8</td></tr>
<tr><td>D_SENIOR</td><td>100</td></tr>
<tr><td>UNDERATD_SENIOR</td><td>100</td></tr>
<tr><td>OTHER_SENIOR</td><td>100</td></tr>
<tr><td>AAA_JUNIOR</td><td>1.2</td></tr>
<tr><td>AA+_JUNIOR</td><td>1.2</td></tr>
<tr><td>AA_JUNIOR</td><td>2.4</td></tr>
<tr><td>AA-_JUNIOR</td><td>3.2</td></tr>
<tr><td>A+_JUNIOR</td><td>4.8</td></tr>
<tr><td>A_JUNIOR</td><td>6.4</td></tr>
<tr><td>A-_JUNIOR</td><td>9.6</td></tr>
<tr><td>BBB+_JUNIOR</td><td>13.6</td></tr>
<tr><td>BBB_JUNIOR</td><td>17.6</td></tr>
<tr><td>BBB-_JUNIOR</td><td>26.4</td></tr>
<tr><td>BB+_JUNIOR</td><td>37.6</td></tr>
<tr><td>BB_JUNIOR</td><td>49.6</td></tr>
<tr><td>BB-_JUNIOR</td><td>60</td></tr>
<tr><td>B+_JUNIOR  </td><td>72</td></tr>
<tr><td>B_JUNIOR</td><td>84</td></tr>
<tr><td>B-_JUNIOR</td><td>90.4</td></tr>
<tr><td>CCC+_JUNIOR</td><td>100</td></tr>
<tr><td>CCC_JUNIOR</td><td>100</td></tr>
<tr><td>CCC-_JUNIOR</td><td>100</td></tr>
<tr><td>D_JUNIOR</td><td>100</td></tr>
<tr><td>UNDERATD_JUNIOR</td><td>100</td></tr>
<tr><td>OTHER_JUNIOR</td><td>100</td></tr>
<tr><td>A-1_JUNIOR</td><td>1.2</td></tr>
<tr><td>A-1_SENIOR</td><td>1.2</td></tr>
<tr><td>P-1_JUNIOR</td><td>1.2</td></tr>
<tr><td>P-1_SENIOR</td><td>1.2</td></tr>
<tr><td>A-2_JUNIOR</td><td>4</td></tr>
<tr><td>A-2_SENIOR</td><td>4</td></tr>
<tr><td>P-2_JUNIOR</td><td>4</td></tr>
<tr><td>P-2_SENIOR</td><td>4</td></tr>
<tr><td>A-3_JUNIOR</td><td>8</td></tr>
<tr><td>A-3_SENIOR</td><td>8</td></tr>
<tr><td>P-3_JUNIOR</td><td>8</td></tr>
<tr><td>P-3_SENIOR</td><td>8</td></tr>
<tr><td>UNDERATD_JUNIOR</td><td>100</td></tr>
<tr><td>UNDERATD_SENIOR</td><td>100</td></tr>
<tr><td>AAA_NONSENIOR</td><td>1.2</td></tr>
<tr><td>AA+_NONSENIOR</td><td>1.2</td></tr>
<tr><td>AA_NONSENIOR</td><td>2.4</td></tr>
<tr><td>AA-_NONSENIOR</td><td>3.2</td></tr>
<tr><td>A+_NONSENIOR</td><td>4.8</td></tr>
<tr><td>A_NONSENIOR</td><td>6.4</td></tr>
<tr><td>A-_NONSENIOR</td><td>9.6</td></tr>
<tr><td>BBB+_NONSENIOR</td><td>13.6</td></tr>
<tr><td>BBB_NONSENIOR</td><td>17.6</td></tr>
<tr><td>BBB-_NONSENIOR</td><td>26.4</td></tr>
<tr><td>BB+_NONSENIOR</td><td>37.6</td></tr>
<tr><td>BB_NONSENIOR</td><td>49.6</td></tr>
<tr><td>BB-_NONSENIOR</td><td>60</td></tr>
<tr><td>B+_NONSENIOR</td><td>72</td></tr>
<tr><td>B_NONSENIOR</td><td>84</td></tr>
<tr><td>B-_NONSENIOR</td><td>90.4</td></tr>
<tr><td>CCC+_NONSENIOR</td><td>100</td></tr>
<tr><td>CCC_NONSENIOR</td><td>100</td></tr>
<tr><td>CCC-_NONSENIOR</td><td>100</td></tr>
<tr><td>D_NONSENIOR</td><td>100</td></tr>
<tr><td>UNDERATD_NONSENIOR</td><td>100</td></tr>
<tr><td>OTHER_NONSENIOR</td><td>100</td></tr>
<tr><td>A-1_NONSENIOR</td><td>1.2</td></tr>
<tr><td>P-1_NONSENIOR</td><td>1.2</td></tr>
<tr><td>A-2_NONSENIOR</td><td>4</td></tr>
<tr><td>P-2_NONSENIOR</td><td>4</td></tr>
<tr><td>A-3_NONSENIOR</td><td>8</td></tr>
<tr><td>P-3_NONSENIOR</td><td>8</td></tr>
<tr><td>UNDERATD_NONSENIOR</td><td>100</td></tr>
<tr><td>D_NONSENIOR</td><td>100</td></tr>
<tr><td>AAA_SUBORDINATE</td><td>1.2</td></tr>
<tr><td>AA+_SUBORDINATE</td><td>1.2</td></tr>
<tr><td>AA_SUBORDINATE</td><td>2.4</td></tr>
<tr><td>AA-_SUBORDINATE</td><td>3.2</td></tr>
<tr><td>A+_SUBORDINATE</td><td>4.8</td></tr>
<tr><td>A_SUBORDINATE</td><td>6.4</td></tr>
<tr><td>A-_SUBORDINATE</td><td>9.6</td></tr>
<tr><td>BBB+_SUBORDINATE</td><td>13.6</td></tr>
<tr><td>BBB_SUBORDINATE</td><td>17.6</td></tr>
<tr><td>BBB-_SUBORDINATE</td><td>26.4</td></tr>
<tr><td>BB+_SUBORDINATE</td><td>37.6</td></tr>
<tr><td>BB_SUBORDINATE</td><td>49.6</td></tr>
<tr><td>BB-_SUBORDINATE</td><td>60</td></tr>
<tr><td>B+_SUBORDINATE</td><td>72</td></tr>
<tr><td>B_SUBORDINATE</td><td>84</td></tr>
<tr><td>B-_SUBORDINATE</td><td>90.4</td></tr>
<tr><td>CC+_SUBORDINATE</td><td>100</td></tr>
<tr><td>CC_SUBORDINATE</td><td>100</td></tr>
<tr><td>CC-_SUBORDINATE</td><td>100</td></tr>
<tr><td>D_SUBORDINATE</td><td>100</td></tr>
<tr><td>UNDERATD_SUBORDINATE</td><td>100</td></tr>
<tr><td>OTHER_SUBORDINATE</td><td>100</td></tr>
<tr><td>A-1_SUBORDINATE</td><td>1.2</td></tr>
<tr><td>P-1_SUBORDINATE</td><td>1.2</td></tr>
<tr><td>A-2_SUBORDINATE</td><td>4</td></tr>
<tr><td>P-2_SUBORDINATE</td><td>4</td></tr>
<tr><td>A-3_SUBORDINATE</td><td>8</td></tr>
<tr><td>P-3_SUBORDINATE</td><td>8</td></tr>
<tr><td>UNDERATD_SUBORDINATE</td><td>100</td></tr>
<tr><td>D_SUBORDINATE</td><td>100</td></tr>
</tbody></table>
</div>
<h3 id="drc-nonsec---bcbs-creditqiality-weights"><a class="header" href="#drc-nonsec---bcbs-creditqiality-weights">DRC nonSec - BCBS CreditQiality Weights</a></h3>
<div class="table-wrapper"><table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>CreditQuality</td><td>WeightBCBS</td></tr>
<tr><td>AAA</td><td>0.005</td></tr>
<tr><td>AA</td><td>0.02</td></tr>
<tr><td>A</td><td>0.03</td></tr>
<tr><td>BBB</td><td>0.06</td></tr>
<tr><td>BAA</td><td>0.06</td></tr>
<tr><td>BB</td><td>0.15</td></tr>
<tr><td>BA</td><td>0.15</td></tr>
<tr><td>B</td><td>0.3</td></tr>
<tr><td>CCC</td><td>0.5</td></tr>
<tr><td>CAA</td><td>0.5</td></tr>
<tr><td>CA</td><td>0.5</td></tr>
<tr><td>UNRATED</td><td>0.15</td></tr>
<tr><td>NORATING</td><td>0.15</td></tr>
<tr><td>DEFAULTED</td><td>1</td></tr>
<tr><td></td><td></td></tr>
<tr><td>CreditQuality</td><td>WeightCRR2</td></tr>
<tr><td>AAA</td><td>0.005</td></tr>
<tr><td>AA</td><td>0.005</td></tr>
<tr><td>A</td><td>0.03</td></tr>
<tr><td>BBB</td><td>0.06</td></tr>
<tr><td>BAA</td><td>0.06</td></tr>
<tr><td>BB</td><td>0.15</td></tr>
<tr><td>BA</td><td>0.15</td></tr>
<tr><td>B</td><td>0.3</td></tr>
<tr><td>CCC</td><td>0.5</td></tr>
<tr><td>CAA</td><td>0.5</td></tr>
<tr><td>CA</td><td>0.5</td></tr>
<tr><td>UNRATED</td><td>0.15</td></tr>
<tr><td>NORATING</td><td>0.15</td></tr>
<tr><td>DEFAULTED</td><td>1</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="define-your-own-measures"><a class="header" href="#define-your-own-measures">Define your own Measures</a></h1>
<p>One of the most powerful features of this Cube is the fact that you can define you own measures/calculations.</p>
<p>Please read the <strong><a href="https://medium.com/@anatoly.bugakov/ultibi-perform-custom-bespoke-dataframe-operation-through-a-ui-44eb10bbef2b">this article</a></strong> for details.</p>
<p>There are two kinds of <strong>Calculators</strong>:</p>
<ol>
<li>
<p><em>Standard Calculator</em> returns a polars expression. Use this when you can.</p>
</li>
<li>
<p><em>Custom Calculator</em> returns a Polars Series. It's flexible but is slower due to the code executing in <code>Python</code> and therefore locking the GIL.</p>
</li>
</ol>
<p>There are two kinds of <strong>Measures</strong>:</p>
<ol>
<li><em>BaseMeasure</em> executed within .filter().groupby().agg() context.</li>
<li><em>DependantMeasure</em> executed within .with_columns() context, but after underlying BaseMeasures were executed (in their respective context).</li>
</ol>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p><strong>Note 1:</strong> In this example the <code>kwargs</code> are <code>parameters</code> will be passed to your function through the <a href="inputs/./calculation/calculate.html">request</a>. See the chapter on <a href="inputs/./calc_params.html">Calc Params</a></p>
<p><strong>Note 2:</strong> make sure your function signatures are exactly as per the example</p>
<pre><code class="language-python">import ultibi as ul
import polars as pl
import os

os.environ[&quot;RUST_LOG&quot;] = &quot;info&quot;  # enable logs
os.environ[&quot;ADDRESS&quot;] = &quot;0.0.0.0:8000&quot;  # host on this address

# Read Data
# for more details: https://pola-rs.github.io/polars/py-polars/html/reference/api/polars.read_csv.html
df = pl.read_csv(&quot;./data/titanic.csv&quot;)

# Let's add some Custom/Bespoke Calculations to our UI


# Standard Calculator
def survival_mean_age(kwargs: dict[str, str]) -&gt; pl.Expr:
    &quot;&quot;&quot;Mean Age of Survivals
    pl.col(&quot;survived&quot;) is 0 or 1
    pl.col(&quot;age&quot;) * pl.col(&quot;survived&quot;) - age of survived person, otherwise 0
    pl.col(&quot;survived&quot;).sum() - number of survived
    &quot;&quot;&quot;
    return pl.col(&quot;age&quot;) * pl.col(&quot;survived&quot;) / pl.col(&quot;survived&quot;).sum()


# Also a Standard Calculator
def example_dep_calc(kwargs: dict[str, str]) -&gt; pl.Expr:
    return pl.col(&quot;SurvivalMeanAge_sum&quot;) + pl.col(&quot;SouthamptonFareDivAge_sum&quot;)


# When we need more involved calculations we go for a Custom Calculator
def custom_calculator(srs: list[pl.Series], kwargs: dict[str, str]) -&gt; pl.Series:
    &quot;&quot;&quot;
    Southampton Fare/Age*multiplier
    &quot;&quot;&quot;
    df = pl.DataFrame({&quot;age&quot;: srs[0], &quot;fare&quot;: srs[1], &quot;e&quot;: srs[2]})
    # Add Indicator Column for Southampton
    df = df.with_columns(pl.when(pl.col(&quot;e&quot;) == &quot;S&quot;).then(1).otherwise(0).alias(&quot;S&quot;))
    multiplier = float(kwargs.get(&quot;multiplier&quot;, 1))
    res = df[&quot;S&quot;] * df[&quot;fare&quot;] / df[&quot;age&quot;] * multiplier
    return res


# inputs for the custom_calculator srs param
inputs = [&quot;age&quot;, &quot;fare&quot;, &quot;embarked&quot;]
# We return Floats
res_type = pl.Float64
# We return a Series, not a scalar (which otherwise would be auto exploded)
returns_scalar = False

measures = [
    ul.BaseMeasure(
        &quot;SouthamptonFareDivAge&quot;,
        ul.CustomCalculator(custom_calculator, res_type, inputs, returns_scalar),
        # (Optional) - we are only interested in Southampton, so
        # unless other measures requested we might as well filter
        # for Southampton only
        # However, if if multiple measures requested, their
        # precompute_filters will be joined as OR.
        [[ul.EqFilter(&quot;embarked&quot;, &quot;S&quot;)]],
        # PARAMS tab of the UI
        calc_params=[ul.CalcParam(&quot;mltplr&quot;, &quot;1&quot;, &quot;float&quot;)],
    ),
    ul.BaseMeasure(
        &quot;SurvivalMeanAge&quot;,
        ul.StandardCalculator(survival_mean_age),
        aggregation_restriction=&quot;sum&quot;,
    ),
    ul.DependantMeasure(
        &quot;A_Dependant_Measure&quot;,
        ul.StandardCalculator(example_dep_calc),
        [(&quot;SurvivalMeanAge&quot;, &quot;sum&quot;), (&quot;SouthamptonFareDivAge&quot;, &quot;sum&quot;)],
    ),
]

# Convert it into an Ultibi DataSet
ds = ul.DataSet.from_frame(df, bespoke_measures=measures)

ds.ui()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend-calculation"><a class="header" href="#backend-calculation">Backend Calculation</a></h1>
<p>In the following chapter we describe what's happening under the hood of our UI Pivot table. <strong>If you are only using the UI, then you don't really need to understand this.</strong> Yet, we recommend you go through it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="assign-weightsprepare"><a class="header" href="#assign-weightsprepare">Assign Weights/Prepare</a></h1>
<p><strong>Currently this section only applies to FRTBDataSet</strong>. In the future <code>python</code> users will be able to define their own, custom <code>prepare</code> functions too.</p>
<p>Prepare is a <strong>fixed</strong> calculation which happens with every request for scans/db DataSources. For InMemory it happens only when you call <code>.prepare()</code>.</p>
<p><code>from_config()</code> call <code>.prepare()</code> depending on <code>source_type</code>.</p>
<p>A good usecase for that is to assign weights column to your data, as per FRTB regulation for example. <strong>Make sure you assign weights before doing any computations</strong>:</p>
<pre><code class="language-python"># TODO scan here to demonstrate prepare

import polars as pl
import ultibi as ul

# Note: sometimes Polars needs abit of help to determine the correct datatype for your
# columns. This is because Polars scans first N rows to determine correct dtype
exposures = pl.read_csv(&quot;./data/frtb/Delta.csv&quot;, dtypes={&quot;SensitivitySpot&quot;: pl.Float64})
# Feel free to join other attributes such as Hierarchy here ...
ds = ul.FRTBDataSet.from_frame(exposures)

original = ds.frame()  # keep the old value for comparison

ds.prepare()

prepared = ds.frame()


# Let's see what happened
def diff(df1: pl.DataFrame, df2: pl.DataFrame) -&gt; pl.DataFrame:
    &quot;&quot;&quot;Columns in df1 which are not in df2

    Args:
        df1 (pl.DataFrame): First to compare
        df2 (pl.DataFrame): Second to compare

    Returns:
        pl.DataFrame: _description_
    &quot;&quot;&quot;
    return df1.select([c for c in df1 if c.name not in df2])


diff_frame = diff(prepared, original)
print(diff_frame.columns)
</code></pre>
<p>You will get an error if you try to assign twice. Now, let's see what happened. We will need a little helper function:</p>
<p>At the time of writing this returns 6 new columns(names of the columns might change slightly but the meaning will always be the same):</p>
<div class="table-wrapper"><table><thead><tr><th>Column Name</th><th>Explanation</th></tr></thead><tbody>
<tr><td>SensWeights</td><td>List of weights, one for each tenor. Eg [1,1,1,1,1] for any Vega risk.</td></tr>
<tr><td>CurvatureRiskWeight</td><td>Simply max of SensWeights if PnL Up or Down was provided, otherwise NULL. This is how we identify Curvature eligible trades.</td></tr>
<tr><td>SensWeightsCRR2</td><td>Same as SensWeights but under CRR2 rules.</td></tr>
<tr><td>CurvatureRiskWeightCRR2</td><td>Same logic as BCBS</td></tr>
<tr><td>ScaleFactor</td><td>DRC scailing: yearfrac between COB and MaturityDate</td></tr>
<tr><td>SeniorityRank</td><td>Mapping used internaly for DRC offsetting</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="calculation"><a class="header" href="#calculation">Calculation</a></h1>
<h2 id="before-you-run"><a class="header" href="#before-you-run">Before you run</a></h2>
<p>Before you specify what you want to calculate <strong>make sure the measure/risk metric you are interested in is present in the dataset</strong>:</p>
<pre><code class="language-python">print( ds.measures )
</code></pre>
<p>What you get there is a <code>dict</code>. The <strong>keys</strong> are measures' name. For example <code>SensitivitySpot</code> or <code>FX DeltaCharge Low</code>. The <strong>items</strong> indicate if there is any <em>restriction on aggregation method</em>, where <code>scalar</code> is a special method explained below. If <code>None</code>, you are free to use any of the availiable:</p>
<pre><code class="language-python">print( ul.aggregation_ops() )
</code></pre>
<p>Note that any numeric column automatically considered a measure (eg <code>SensitivitySpot</code>). These measures can be aggregated any way you want for a given level, say Desk. In other words, for a given Desk you can find the mean, max, min or sum (etc etc) of <code>SensitivitySpot</code>. On the other hand, you can <strong>not</strong> find mean, max, min (etc etc) of <code>FX DeltaCharge Low</code>. This wouldn't make sence since <code>FX DeltaCharge Low</code> is simply a single number defined by the regulation. Hence we call such aggregation method <strong><code>scalar</code></strong> and we <strong>restrict</strong> you to use only this method.</p>
<p>Also, make sure that columns which appear in measures, grouby and filters are present as well.</p>
<h2 id="run"><a class="header" href="#run">Run</a></h2>
<p>Now we are good to form the request which we need. Say, we want to understand the <code>DRC</code> capital charge and all intermediate results, for every combination of <code>Desk</code> - <code>BucketBCBS</code>.</p>
<pre><code class="language-python"># What do we want to calculate?
request = dict(
    measures=[
        [&quot;DRC nonSec GrossJTD&quot;, &quot;sum&quot;],
        [&quot;DRC nonSec GrossJTD Scaled&quot;, &quot;sum&quot;],
        [&quot;DRC nonSec CapitalCharge&quot;, &quot;scalar&quot;],
        [&quot;DRC nonSec NetLongJTD&quot;, &quot;scalar&quot;],
        [&quot;DRC nonSec NetShortJTD&quot;, &quot;scalar&quot;],
        [&quot;DRC nonSec NetLongJTD Weighted&quot;, &quot;scalar&quot;],
        [&quot;DRC nonSec NetAbsShortJTD Weighted&quot;, &quot;scalar&quot;],
        [&quot;DRC nonSec HBR&quot;, &quot;scalar&quot;],
    ],
    groupby=[&quot;Desk&quot;, &quot;BucketBCBS&quot;],
    hide_zeros=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
        &quot;drc_offset&quot;: &quot;true&quot;,
    },
)
</code></pre>
<p>Note: if you don't care about level of aggregation and just want a total say DRC Capital Charge for your portfolio, just provide an extra column to your portfolio, name it <code>&quot;Total&quot;</code>(for exmaple) and set all values in the columns as <code>&quot;Total&quot;</code>. Then do <code>groupby=[&quot;Total&quot;]</code>. Above request has two <strong>optional</strong> parameters which we haven't talked about yet: <code>hide_zeros</code> and <code>calc_params</code>. <code>hide_zeros</code> simply removes rows <strong>from the result</strong> where each measure is 0, and <code>calc_params</code> allows you to override default parameters such as <code>jurisdiction</code>, <code>reporting_ccy</code>, <code>girr_delta_rho_diff_curve_base</code> (and many many others. We will talk about in <a href="calculation/./whatif.html">analysis</a> chapter) etc.</p>
<p>Valide that you've formed a legitimate request (ie no compulsory field is missing, datatypes are correct etc):</p>
<pre><code class="language-python">aggrequest = ul.AggRequest(request)
print(request)
</code></pre>
<p>Finally, to execute</p>
<pre><code class="language-python">result = ds.compute(request)
print(result)
print(&quot;Type: &quot;, type(result))
</code></pre>
<p>Notice the returned object is a polars DataFrame. You can then do whatever you want with it. Print (to set how many columns you want to print make sure to use polars <a href="https://pola-rs.github.io/polars/py-polars/html/reference/config.html">config</a>), or any on the <a href="https://pola-rs.github.io/polars/py-polars/html/reference/io.html">I/O</a>: save to csv, parquet, database etc.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="frtb-supported-measures"><a class="header" href="#frtb-supported-measures">FRTB Supported measures</a></h1>
<p>At the time of writing:</p>
<pre><code class="language-python">ds = ul.FRTBDataSet.from_frame(df)
for m in ds.measures.keys():
    print(m)
</code></pre>
<p>CSR Sec CTP CVRdown</p>
<p>CSR Sec CTP CVRup</p>
<p>CSR Sec CTP Curvature Kb High</p>
<p>CSR Sec CTP Curvature Kb Low</p>
<p>CSR Sec CTP Curvature Kb Medium</p>
<p>CSR Sec CTP Curvature KbMinus High</p>
<p>CSR Sec CTP Curvature KbMinus Low</p>
<p>CSR Sec CTP Curvature KbMinus Medium</p>
<p>CSR Sec CTP Curvature KbPlus High</p>
<p>CSR Sec CTP Curvature KbPlus Low</p>
<p>CSR Sec CTP Curvature KbPlus Medium</p>
<p>CSR Sec CTP Curvature Sb High</p>
<p>CSR Sec CTP Curvature Sb Low</p>
<p>CSR Sec CTP Curvature Sb Medium</p>
<p>CSR Sec CTP CurvatureCharge High</p>
<p>CSR Sec CTP CurvatureCharge Low</p>
<p>CSR Sec CTP CurvatureCharge MAX</p>
<p>CSR Sec CTP CurvatureCharge Medium</p>
<p>CSR Sec CTP CurvatureDelta</p>
<p>CSR Sec CTP CurvatureDelta_Weighted</p>
<p>CSR Sec CTP DeltaCharge High</p>
<p>CSR Sec CTP DeltaCharge Low</p>
<p>CSR Sec CTP DeltaCharge MAX</p>
<p>CSR Sec CTP DeltaCharge Medium</p>
<p>CSR Sec CTP DeltaKb High</p>
<p>CSR Sec CTP DeltaKb Low</p>
<p>CSR Sec CTP DeltaKb Medium</p>
<p>CSR Sec CTP DeltaSb</p>
<p>CSR Sec CTP DeltaSens</p>
<p>CSR Sec CTP DeltaSens Weighted</p>
<p>CSR Sec CTP PnLdown</p>
<p>CSR Sec CTP PnLup</p>
<p>CSR Sec CTP TotalCharge High</p>
<p>CSR Sec CTP TotalCharge Low</p>
<p>CSR Sec CTP TotalCharge Medium</p>
<p>CSR Sec CTP VegaCharge High</p>
<p>CSR Sec CTP VegaCharge Low</p>
<p>CSR Sec CTP VegaCharge MAX</p>
<p>CSR Sec CTP VegaCharge Medium</p>
<p>CSR Sec CTP VegaKb High</p>
<p>CSR Sec CTP VegaKb Low</p>
<p>CSR Sec CTP VegaKb Medium</p>
<p>CSR Sec CTP VegaSb</p>
<p>CSR Sec CTP VegaSens</p>
<p>CSR Sec CTP VegaSens Weighted</p>
<p>CSR Sec nonCTP CVRdown</p>
<p>CSR Sec nonCTP CVRup</p>
<p>CSR Sec nonCTP Curvature Kb High</p>
<p>CSR Sec nonCTP Curvature Kb Low</p>
<p>CSR Sec nonCTP Curvature Kb Medium</p>
<p>CSR Sec nonCTP Curvature KbMinus High</p>
<p>CSR Sec nonCTP Curvature KbMinus Low</p>
<p>CSR Sec nonCTP Curvature KbMinus Medium</p>
<p>CSR Sec nonCTP Curvature KbPlus High</p>
<p>CSR Sec nonCTP Curvature KbPlus Low</p>
<p>CSR Sec nonCTP Curvature KbPlus Medium</p>
<p>CSR Sec nonCTP Curvature Sb High</p>
<p>CSR Sec nonCTP Curvature Sb Low</p>
<p>CSR Sec nonCTP Curvature Sb Medium</p>
<p>CSR Sec nonCTP CurvatureCharge High</p>
<p>CSR Sec nonCTP CurvatureCharge Low</p>
<p>CSR Sec nonCTP CurvatureCharge MAX</p>
<p>CSR Sec nonCTP CurvatureCharge Medium</p>
<p>CSR Sec nonCTP CurvatureDelta</p>
<p>CSR Sec nonCTP CurvatureDelta Weighted</p>
<p>CSR Sec nonCTP DeltaCharge High</p>
<p>CSR Sec nonCTP DeltaCharge Low</p>
<p>CSR Sec nonCTP DeltaCharge MAX</p>
<p>CSR Sec nonCTP DeltaCharge Medium</p>
<p>CSR Sec nonCTP DeltaKb High</p>
<p>CSR Sec nonCTP DeltaKb Low</p>
<p>CSR Sec nonCTP DeltaKb Medium</p>
<p>CSR Sec nonCTP DeltaSb</p>
<p>CSR Sec nonCTP DeltaSens</p>
<p>CSR Sec nonCTP DeltaSens Weighted</p>
<p>CSR Sec nonCTP PnLdown</p>
<p>CSR Sec nonCTP PnLup</p>
<p>CSR Sec nonCTP TotalCharge High</p>
<p>CSR Sec nonCTP TotalCharge Low</p>
<p>CSR Sec nonCTP TotalCharge Medium</p>
<p>CSR Sec nonCTP VegaCharge High</p>
<p>CSR Sec nonCTP VegaCharge Low</p>
<p>CSR Sec nonCTP VegaCharge MAX</p>
<p>CSR Sec nonCTP VegaCharge Medium</p>
<p>CSR Sec nonCTP VegaKb High</p>
<p>CSR Sec nonCTP VegaKb Low</p>
<p>CSR Sec nonCTP VegaKb Medium</p>
<p>CSR Sec nonCTP VegaSb</p>
<p>CSR Sec nonCTP VegaSens</p>
<p>CSR Sec nonCTP VegaSens Weighted</p>
<p>CSR nonSec CVRdown</p>
<p>CSR nonSec CVRup</p>
<p>CSR nonSec Curvature Kb High</p>
<p>CSR nonSec Curvature Kb Low</p>
<p>CSR nonSec Curvature Kb Medium</p>
<p>CSR nonSec Curvature KbMinus High</p>
<p>CSR nonSec Curvature KbMinus Low</p>
<p>CSR nonSec Curvature KbMinus Medium</p>
<p>CSR nonSec Curvature KbPlus High</p>
<p>CSR nonSec Curvature KbPlus Low</p>
<p>CSR nonSec Curvature KbPlus Medium</p>
<p>CSR nonSec Curvature Sb High</p>
<p>CSR nonSec Curvature Sb Low</p>
<p>CSR nonSec Curvature Sb Medium</p>
<p>CSR nonSec CurvatureCharge High</p>
<p>CSR nonSec CurvatureCharge Low</p>
<p>CSR nonSec CurvatureCharge MAX</p>
<p>CSR nonSec CurvatureCharge Medium</p>
<p>CSR nonSec CurvatureDelta</p>
<p>CSR nonSec CurvatureDeltaWeighted</p>
<p>CSR nonSec DeltaCharge High</p>
<p>CSR nonSec DeltaCharge Low</p>
<p>CSR nonSec DeltaCharge MAX</p>
<p>CSR nonSec DeltaCharge Medium</p>
<p>CSR nonSec DeltaKb High</p>
<p>CSR nonSec DeltaKb Low</p>
<p>CSR nonSec DeltaKb Medium</p>
<p>CSR nonSec DeltaSb</p>
<p>CSR nonSec DeltaSens</p>
<p>CSR nonSec DeltaSens Weighted</p>
<p>CSR nonSec PnLdown</p>
<p>CSR nonSec PnLup</p>
<p>CSR nonSec TotalCharge High</p>
<p>CSR nonSec TotalCharge Low</p>
<p>CSR nonSec TotalCharge MAX</p>
<p>CSR nonSec TotalCharge Medium</p>
<p>CSR nonSec VegaCharge High</p>
<p>CSR nonSec VegaCharge Low</p>
<p>CSR nonSec VegaCharge MAX</p>
<p>CSR nonSec VegaCharge Medium</p>
<p>CSR nonSec VegaKb High</p>
<p>CSR nonSec VegaKb Low</p>
<p>CSR nonSec VegaKb Medium</p>
<p>CSR nonSec VegaSb</p>
<p>CSR nonSec VegaSens</p>
<p>CSR nonSec VegaSens Weighted</p>
<p>Commodity CVRdown</p>
<p>Commodity CVRup</p>
<p>Commodity Curvature Kb High</p>
<p>Commodity Curvature Kb Low</p>
<p>Commodity Curvature Kb Medium</p>
<p>Commodity Curvature KbMinus High</p>
<p>Commodity Curvature KbMinus Low</p>
<p>Commodity Curvature KbMinus Medium</p>
<p>Commodity Curvature KbPlus High</p>
<p>Commodity Curvature KbPlus Low</p>
<p>Commodity Curvature KbPlus Medium</p>
<p>Commodity Curvature Sb High</p>
<p>Commodity Curvature Sb Low</p>
<p>Commodity Curvature Sb Medium</p>
<p>Commodity CurvatureCharge High</p>
<p>Commodity CurvatureCharge Low</p>
<p>Commodity CurvatureCharge MAX</p>
<p>Commodity CurvatureCharge Medium</p>
<p>Commodity CurvatureDelta</p>
<p>Commodity CurvatureDelta Weighted</p>
<p>Commodity DeltaCharge High</p>
<p>Commodity DeltaCharge Low</p>
<p>Commodity DeltaCharge MAX</p>
<p>Commodity DeltaCharge Medium</p>
<p>Commodity DeltaKb High</p>
<p>Commodity DeltaKb Low</p>
<p>Commodity DeltaKb Medium</p>
<p>Commodity DeltaSb</p>
<p>Commodity DeltaSens</p>
<p>Commodity DeltaSens Weighted</p>
<p>Commodity PnLdown</p>
<p>Commodity PnLup</p>
<p>Commodity TotalCharge High</p>
<p>Commodity TotalCharge Low</p>
<p>Commodity TotalCharge MAX</p>
<p>Commodity TotalCharge Medium</p>
<p>Commodity VegaCharge High</p>
<p>Commodity VegaCharge Low</p>
<p>Commodity VegaCharge MAX</p>
<p>Commodity VegaCharge Medium</p>
<p>Commodity VegaKb High</p>
<p>Commodity VegaKb Low</p>
<p>Commodity VegaKb Medium</p>
<p>Commodity VegaSb</p>
<p>Commodity VegaSens</p>
<p>Commodity VegaSens Weighted</p>
<p>DRC Charge</p>
<p>DRC Sec nonCTP CapitalCharge</p>
<p>DRC Sec nonCTP GrossJTD</p>
<p>DRC Sec nonCTP GrossJTD Scaled</p>
<p>DRC Sec nonCTP HBR</p>
<p>DRC Sec nonCTP NetLongJTD</p>
<p>DRC Sec nonCTP NetLongJTD Weighted</p>
<p>DRC Sec nonCTP NetShortJTD</p>
<p>DRC Sec nonCTP NetShortJTD Weighted</p>
<p>DRC nonSec CapitalCharge</p>
<p>DRC nonSec GrossJTD</p>
<p>DRC nonSec GrossJTD Scaled</p>
<p>DRC nonSec HBR</p>
<p>DRC nonSec NetAbsShortJTD Weighted</p>
<p>DRC nonSec NetLongJTD</p>
<p>DRC nonSec NetLongJTD Weighted</p>
<p>DRC nonSec NetShortJTD</p>
<p>EQ CVRdown</p>
<p>EQ CVRup</p>
<p>EQ Curvature Kb High</p>
<p>EQ Curvature Kb Low</p>
<p>EQ Curvature Kb Medium</p>
<p>EQ Curvature KbMinus High</p>
<p>EQ Curvature KbMinus Low</p>
<p>EQ Curvature KbMinus Medium</p>
<p>EQ Curvature KbPlus High</p>
<p>EQ Curvature KbPlus Low</p>
<p>EQ Curvature KbPlus Medium</p>
<p>EQ Curvature Sb High</p>
<p>EQ Curvature Sb Low</p>
<p>EQ Curvature Sb Medium</p>
<p>EQ CurvatureCharge High</p>
<p>EQ CurvatureCharge Low</p>
<p>EQ CurvatureCharge MAX</p>
<p>EQ CurvatureCharge Medium</p>
<p>EQ CurvatureDelta</p>
<p>EQ CurvatureDelta_Weighted</p>
<p>EQ DeltaCharge High</p>
<p>EQ DeltaCharge Low</p>
<p>EQ DeltaCharge MAX</p>
<p>EQ DeltaCharge Medium</p>
<p>EQ DeltaKb High</p>
<p>EQ DeltaKb Low</p>
<p>EQ DeltaKb Medium</p>
<p>EQ DeltaSb</p>
<p>EQ DeltaSens</p>
<p>EQ DeltaSens Weighted</p>
<p>EQ PnLdown</p>
<p>EQ PnLup</p>
<p>EQ TotalCharge High</p>
<p>EQ TotalCharge Low</p>
<p>EQ TotalCharge Medium</p>
<p>EQ VegaCharge High</p>
<p>EQ VegaCharge Low</p>
<p>EQ VegaCharge MAX</p>
<p>EQ VegaCharge Medium</p>
<p>EQ VegaKb High</p>
<p>EQ VegaKb Low</p>
<p>EQ VegaKb Medium</p>
<p>EQ VegaSb</p>
<p>EQ VegaSens</p>
<p>EQ VegaSens Weighted</p>
<p>Exotic RRAO Charge</p>
<p>Exotic RRAO Notional</p>
<p>FX CVRdown</p>
<p>FX CVRup</p>
<p>FX Curvature Kb</p>
<p>FX Curvature KbMinus</p>
<p>FX Curvature KbPlus</p>
<p>FX Curvature Sb</p>
<p>FX CurvatureCharge High</p>
<p>FX CurvatureCharge Low</p>
<p>FX CurvatureCharge MAX</p>
<p>FX CurvatureCharge Medium</p>
<p>FX CurvatureDelta</p>
<p>FX CurvatureDelta Weighted</p>
<p>FX DeltaCharge High</p>
<p>FX DeltaCharge Low</p>
<p>FX DeltaCharge MAX</p>
<p>FX DeltaCharge Medium</p>
<p>FX DeltaKb</p>
<p>FX DeltaSb</p>
<p>FX DeltaSens</p>
<p>FX DeltaSens Weighted</p>
<p>FX PnLdown</p>
<p>FX PnLup</p>
<p>FX TotalCharge High</p>
<p>FX TotalCharge Low</p>
<p>FX TotalCharge Medium</p>
<p>FX VegaCharge High</p>
<p>FX VegaCharge Low</p>
<p>FX VegaCharge MAX</p>
<p>FX VegaCharge Medium</p>
<p>FX VegaKb High</p>
<p>FX VegaKb Low</p>
<p>FX VegaKb Medium</p>
<p>FX VegaSb</p>
<p>FX VegaSens</p>
<p>FX VegaSens Weighted</p>
<p>GIRR CVRdown</p>
<p>GIRR CVRup</p>
<p>GIRR Curvature Kb</p>
<p>GIRR Curvature KbMinus</p>
<p>GIRR Curvature KbPlus</p>
<p>GIRR Curvature Sb</p>
<p>GIRR CurvatureCharge High</p>
<p>GIRR CurvatureCharge Low</p>
<p>GIRR CurvatureCharge MAX</p>
<p>GIRR CurvatureCharge Medium</p>
<p>GIRR CurvatureDelta</p>
<p>GIRR CurvatureDelta Weighted</p>
<p>GIRR DeltaCharge High</p>
<p>GIRR DeltaCharge Low</p>
<p>GIRR DeltaCharge MAX</p>
<p>GIRR DeltaCharge Medium</p>
<p>GIRR DeltaKb High</p>
<p>GIRR DeltaKb Low</p>
<p>GIRR DeltaKb Medium</p>
<p>GIRR DeltaSb</p>
<p>GIRR DeltaSens</p>
<p>GIRR DeltaSens Weighted</p>
<p>GIRR PnLdown</p>
<p>GIRR PnLup</p>
<p>GIRR TotalCharge High</p>
<p>GIRR TotalCharge Low</p>
<p>GIRR TotalCharge Medium</p>
<p>GIRR VegaCharge High</p>
<p>GIRR VegaCharge Low</p>
<p>GIRR VegaCharge MAX</p>
<p>GIRR VegaCharge Medium</p>
<p>GIRR VegaKb High</p>
<p>GIRR VegaKb Low</p>
<p>GIRR VegaKb Medium</p>
<p>GIRR VegaSb</p>
<p>GIRR VegaSens</p>
<p>GIRR VegaSens Weighted</p>
<p>GrossJTD</p>
<p>Other RRAO Charge</p>
<p>Other RRAO Notional</p>
<p>PnL_Down</p>
<p>PnL_Up</p>
<p>RRAO Charge</p>
<p>RiskWeights</p>
<p>SA Charge</p>
<p>SBM Charge</p>
<p>SBM Charge High</p>
<p>SBM Charge Low</p>
<p>SBM Charge Medium</p>
<p>SensitivitySpot</p>
<p>Sensitivity_025Y</p>
<p>Sensitivity_05Y</p>
<p>Sensitivity_10Y</p>
<p>Sensitivity_1Y</p>
<p>Sensitivity_3Y</p>
<p>Sensitivity_5Y</p>
<p>Total Sens</p>
<p>TradeId</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-if"><a class="header" href="#what-if">What If</a></h1>
<p>This chapter demonstrates all the rich feature selection <code>ultibi</code> offers for your analysis. For instance, you can <strong>override</strong> risk weights, inner/across bucket correlation parameters, trade attributes.</p>
<p>You can instantly <strong>add rows(trades)</strong> to your portfolio to analyse the impact it has on the cpaital charge.</p>
<p>We also provide a wide range of optional <strong>calculation parameters</strong>(such as jurisdiction, etc) which you could chose when performing calculation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="filtering"><a class="header" href="#filtering">Filtering</a></h1>
<p>Often, one would want <strong>filter</strong> their data. May be you are just interested in number of one particular subset (eg a Book). Or, if you are investigating an issue, this can be very useful to narrow down the potential underlying root cause.</p>
<p>Note: you specify type of filter with <code>&quot;op&quot;</code> argument.</p>
<h3 id="equal-eq"><a class="header" href="#equal-eq">Equal (Eq)</a></h3>
<p>In this example we breakdown by <code>Country</code> and <code>RiskClass</code>. We also filter on <code>Desk == FXOptions</code>.</p>
<pre><code class="language-python">import ultibi as ul
import polars as pl

pl.Config.set_tbl_rows(100)
ds = ul.FRTBDataSet.from_config_path(&quot;./data/frtb/datasource_config.toml&quot;)


request = dict(
    measures=[[&quot;SBM Charge&quot;, &quot;scalar&quot;]],
    groupby=[&quot;Country&quot;, &quot;RiskClass&quot;],
    filters=[[{&quot;op&quot;: &quot;Eq&quot;, &quot;field&quot;: &quot;Desk&quot;, &quot;value&quot;: &quot;FXOptions&quot;}]],
    hide_zeros=True,
    totals=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
        &quot;drc_offset&quot;: &quot;true&quot;,
    },
)
result = ds.compute(request)
print(result)
</code></pre>
<h3 id="not-equial-neq"><a class="header" href="#not-equial-neq">Not Equial (Neq)</a></h3>
<p>In this example we breakdown by <code>Country</code> and <code>RiskClass</code>. We also filter on <code>Desk != FXOptions</code>.</p>
<pre><code class="language-python">request = dict(
    measures=[[&quot;SBM Charge&quot;, &quot;scalar&quot;]],
    groupby=[&quot;Country&quot;, &quot;RiskClass&quot;],
    filters=[[{&quot;op&quot;: &quot;Neq&quot;, &quot;field&quot;: &quot;Desk&quot;, &quot;value&quot;: &quot;FXOptions&quot;}]],
    hide_zeros=True,
    totals=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
        &quot;drc_offset&quot;: &quot;true&quot;,
    },
)
result = ds.compute(request)
print(result)
</code></pre>
<h3 id="in-in"><a class="header" href="#in-in">In (In)</a></h3>
<p><code>In</code> is similar to <code>Eq</code>, but instead of one value you can provide multiple. In this example we filter on <code>Desk</code> to be <code>FXOptions</code> or <code>Rates</code>.</p>
<pre><code class="language-python">
request = dict(
    measures=[[&quot;SBM Charge&quot;, &quot;scalar&quot;]],
    groupby=[&quot;Country&quot;, &quot;RiskClass&quot;],
    filters=[[{&quot;op&quot;: &quot;In&quot;, &quot;field&quot;: &quot;Desk&quot;, &quot;value&quot;: [&quot;FXOptions&quot;, &quot;Rates&quot;]}]],
    hide_zeros=True,
    totals=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
        &quot;drc_offset&quot;: &quot;true&quot;,
    },
)
result = ds.compute(request)

print(result)
</code></pre>
<h3 id="not-in-notin"><a class="header" href="#not-in-notin">Not In (NotIn)</a></h3>
<p><code>NotIn</code> is similar to <code>Neq</code>, but instead of saying that column value should not be equal to A, you can say that it should not be equal neither to A not to B. In this example we filter on <code>Desk</code> not being one of <code>FXOptions</code> or <code>Rates</code>.</p>
<pre><code class="language-python">
request = dict(
    measures=[[&quot;SBM Charge&quot;, &quot;scalar&quot;]],
    groupby=[&quot;Country&quot;, &quot;RiskClass&quot;],
    filters=[[{&quot;op&quot;: &quot;NotIn&quot;, &quot;field&quot;: &quot;Desk&quot;, &quot;value&quot;: [&quot;FXOptions&quot;, &quot;Rates&quot;]}]],
    hide_zeros=True,
    totals=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
        &quot;drc_offset&quot;: &quot;true&quot;,
    },
)
result = ds.compute(request)

print(result)
</code></pre>
<h3 id="combining-filters"><a class="header" href="#combining-filters">Combining Filters</a></h3>
<p>You can combine filters as much as you want. In all the previous examples notice that <code>filter</code>. Is a nested list, ie a list of lists. <strong>It is important to keep in mind that inner filters of each list will be joined as <code>OR</code>, while outer filters will be joined as <code>AND</code></strong>. For example, here we want <code>LegalEntity</code> to be equal to <code>EMEA</code> OR <code>Country</code> to be <code>UK</code>, AND we also want <code>RiskClass either FX or Equity</code>.</p>
<pre><code class="language-python">
request = dict(
    measures=[[&quot;SBM Charge&quot;, &quot;scalar&quot;]],
    groupby=[&quot;Country&quot;, &quot;RiskClass&quot;],
    filters=[
        [
            {&quot;op&quot;: &quot;Eq&quot;, &quot;field&quot;: &quot;LegalEntity&quot;, &quot;value&quot;: &quot;EMEA&quot;},
            {&quot;op&quot;: &quot;Eq&quot;, &quot;field&quot;: &quot;Country&quot;, &quot;value&quot;: &quot;UK&quot;},
        ],
        [{&quot;op&quot;: &quot;In&quot;, &quot;field&quot;: &quot;RiskClass&quot;, &quot;value&quot;: [&quot;FX&quot;, &quot;Equity&quot;]}],
    ],
    hide_zeros=True,
    totals=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
        &quot;drc_offset&quot;: &quot;true&quot;,
    },
)
result = ds.compute(request)
print(result)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overrides"><a class="header" href="#overrides">Overrides</a></h1>
<p>You can temporarily override any value in your dataset. This can be very useful to perform analysis. An override consists of three fields:</p>
<ol>
<li>The <strong>Field</strong> (ie the column where you seek to override values).
Note: at the time of writing you can only override <strong>bool, str, number, list of numbers</strong> types of columns.</li>
<li>The New <strong>Value</strong>.</li>
<li>The <strong><a href="./filters.html">Filters</a></strong>. ie when to override the existing with the new value.</li>
</ol>
<p>Let's do a couple of examples. Notice that under <a href="https://www.bis.org/bcbs/publ/d457.pdf">BCBS</a> <em>page <code>59</code> table <code>2</code></em>. the default risk weight is almost the same as under <a href="https://www.eba.europa.eu/regulation-and-policy/single-rulebook/interactive-single-rulebook/108763">CRR2</a>. Assuming that AA is Credit Quality Step 1, if we change the risk weight to <code>0.005</code> we would expect to get the same outcome. Let's test this out:</p>
<pre><code class="language-python">
request = dict(
    filters=[],
    groupby=[&quot;RiskClass&quot;, &quot;Desk&quot;],
    overrides=[
        {
            &quot;field&quot;: &quot;SensWeights&quot;,
            &quot;value&quot;: &quot;[0.005]&quot;,
            &quot;filters&quot;: [
                [{&quot;op&quot;: &quot;Eq&quot;, &quot;field&quot;: &quot;RiskClass&quot;, &quot;value&quot;: &quot;DRC_nonSec&quot;}],
                [{&quot;op&quot;: &quot;Eq&quot;, &quot;field&quot;: &quot;CreditQuality&quot;, &quot;value&quot;: &quot;AA&quot;}],
            ],
        }
    ],
    measures=[[&quot;DRC nonSec CapitalCharge&quot;, &quot;scalar&quot;]],
    hide_zeros=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        &quot;drc_offset&quot;: &quot;false&quot;,
    },
)
result = ds.compute(request)

request = dict(
print(result)
</code></pre>
<p>Note that SensWeights is a list of numbers column (because of multiple tenors) and therefore we write it as a list <code>[0.005]</code>.</p>
<p>Let's compare this to a run <strong>without overrides</strong> but with <strong><code>jurisdiction</code> == <code>CRR2</code></strong>:</p>
<pre><code class="language-python">request = dict(
    filters=[],
    groupby=[&quot;RiskClass&quot;, &quot;Desk&quot;],
    measures=[[&quot;DRC nonSec CapitalCharge&quot;, &quot;scalar&quot;]],
    hide_zeros=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;CRR2&quot;,
        &quot;drc_offset&quot;: &quot;false&quot;,
    },
)
result = ds.compute(request)
print(result)
</code></pre>
<p>Results should match!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="add-rows"><a class="header" href="#add-rows">Add Rows</a></h1>
<p><code>ultibi</code>'s request suppors adding rows(in our case Trades). This is a perfect functionality to have in your toolset, especially for a super quick What If analysis.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>An example of a request with <code>add_row</code> looks like this:</p>
<pre><code class="language-python">import ultibi as ul
import json

ds = ul.FRTBDataSet.from_config_path(&quot;./data/frtb/datasource_config.toml&quot;)

added_rows = dict(
    prepare=True,
    rows=[
        {
            &quot;SensitivitySpot&quot;: &quot;1000000&quot;,
            &quot;PnL_Up&quot;: &quot;0&quot;,
            &quot;PnL_Down&quot;: &quot;0&quot;,
            &quot;COB&quot;: &quot;&quot;,
            &quot;MaturityDate&quot;: &quot;&quot;,
            &quot;RiskClass&quot;: &quot;Commodity&quot;,
            &quot;RiskFactor&quot;: &quot;XAU&quot;,
            &quot;RiskCategory&quot;: &quot;Delta&quot;,
            &quot;RiskFactorType&quot;: &quot;&quot;,
            &quot;BucketBCBS&quot;: &quot;7&quot;,
            &quot;BucketCRR2&quot;: &quot;7&quot;,
            &quot;CreditQuality&quot;: &quot;&quot;,
            &quot;CoveredBondReducedWeight&quot;: &quot;&quot;,
            &quot;Group&quot;: &quot;Ultima&quot;,
        }
    ],
)

added_rows_json = json.dumps(added_rows)

request1 = dict(
    measures=[
        [&quot;Commodity DeltaCharge Low&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge Medium&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge High&quot;, &quot;scalar&quot;],
    ],
    add_row=added_rows,
    groupby=[&quot;Group&quot;],
    hide_zeros=True,
)

result1 = ds.compute(request1)

# print(result1) #&lt;-- uncomment to see

# Now, just for comparison - run metrics without and additional trades
request2 = dict(
    measures=[
        [&quot;Commodity DeltaCharge Low&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge Medium&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge High&quot;, &quot;scalar&quot;],
    ],
    groupby=[&quot;Group&quot;],
    hide_zeros=True,
)

result2 = ds.compute(request2)
print(result1)
print(result2)
</code></pre>
<h2 id="explanation"><a class="header" href="#explanation">Explanation</a></h2>
<p>If you set <code>prepare</code> to true be prepared to provide all the required columns to assign weights.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="calc-params"><a class="header" href="#calc-params">Calc Params</a></h1>
<p>ultibi allows you to override parameters of the regulation, which in turn allows you to define your own parameter sets. For example if a regulatory set is not yet supported - just override parameters which are different in <code>&quot;calc_params&quot;</code> part of your request.</p>
<h2 id="what-you-can-override"><a class="header" href="#what-you-can-override">What you can override</a></h2>
<p>Use <code>.calc_params</code> attribute to get the list of overridable parameters.</p>
<pre><code class="language-python">for calc_param in dataset.calc_params:
    print(calc_param[&quot;name&quot;], &quot; - &quot;, calc_param[&quot;hint&quot;])
</code></pre>
<h2 id="explanation-1"><a class="header" href="#explanation-1">Explanation</a></h2>
<p>Most of these are self explanatory. However, one needs to understand what exactly some of those do:</p>
<ol>
<li>
<p>Some calc_params <strong>end</strong> with <strong>_base</strong> and some with <strong>_low/_medium/_high</strong>. Those which end with <strong>_base</strong> (eg. <code>com_delta_rho_diff_loc_base</code>) are <em>components of an actual rho</em>. For example <code>com_delta_rho_diff_loc_base</code> is (a float) and is part of three components which are multiplied to produce a commodity inner bucket rho as per <code>21.83.3</code>. This has one important implication. <strong>Low/High function as per paragraph <code>21.6</code> in the <a href="https://www.bis.org/bcbs/publ/d457.pdf">text</a> will be applied after this multiplication.</strong> On the other hand, those calc_params which end with <strong>_low/_medium/_high</strong> (eg <code>girr_delta_gamma_low</code>) will be used as they are.</p>
</li>
<li>
<p>Those calc_params (eg <code>com_delta_diff_cty_rho_per_bucket_base</code>) which are lists are usually per bucket, where index of the item indicates the number of the bucket.</p>
</li>
<li>
<p><code>jurisdiction</code> - currently <code>BCBS</code> or <code>CRR2</code> - points to which parameter set (rhos, gammas etc) to be used by default. Also for <strong>FX</strong> if <code>reporting_ccy</code> is not provided</p>
</li>
<li>
<p><code>reporting_ccy</code> - used for <strong>FX</strong>. Only those <strong>FX</strong> delta/curvature sensitivites where RiskFactor is XXXCCY (where CCY is the reporting_ccy) will be used for calculation. (eg if reporting_ccy is USD, GBPUSD will be used, but GBPEUR will not - this applies for Delta and Curvature calculations only).</p>
</li>
<li>
<p>For gamma correlation matrixes the diagonal has to be 0.</p>
</li>
<li>
<p>You have to be very careful with the way to provide a <code>calc_param</code> in your request, especially for vectors and matrixes. <strong>Use <code>json.dumps</code> for calc_params</strong>. Follow examples below. 'v' is always 1.</p>
</li>
</ol>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<p>A request with <code>calc_params</code> looks like this. This is an arbitrary example just for illustrative purposes:</p>
<pre><code class="language-python">import ultibi as ul
import json

ds = ul.FRTBDataSet.from_config_path(&quot;./data/frtb/datasource_config.toml&quot;)

for calc_param in ds.calc_params:
    if &quot;com_delta_&quot; in calc_param[0]:
        # print(calc_param) #&lt;-- uncomment to see
        pass
# fmt: off
com_delta_diff_cty_rho_per_bucket_base = json.dumps(
    [1.55, 1.95, 1.4, 1.8, 1.6, 1.65, 1.55, 1.45, 1.15, 1.4, 1.15]
)
com_delta_gamma_low = json.dumps(
    {
        &quot;v&quot;: 1,
        &quot;dim&quot;: [11, 11],
        &quot;data&quot;: [
            0.0,1.2,1.2,1.2,1.2,1.2,1.2,1.2,1.2,1.2,0.0,
            1.2,0.0,1.2,1.2,1.2,1.2,1.2,1.2,1.2,1.2,0.0,
            1.2,1.2,0.0,1.2,1.2,1.2,1.2,1.2,1.2,1.2,0.0,
            1.2,1.2,1.2,0.0,1.2,1.2,1.2,1.2,1.2,1.2,0.0,
            1.2,1.2,1.2,1.2,0.0,1.2,1.2,1.2,1.2,1.2,0.0,
            1.2,1.2,1.2,1.2,1.2,0.0,1.2,1.2,1.2,1.2,0.0,
            1.2,1.2,1.2,1.2,1.2,1.2,0.0,1.2,1.2,1.2,0.0,
            1.2,1.2,1.2,1.2,1.2,1.2,1.2,0.0,1.2,1.2,0.0,
            1.2,1.2,1.2,1.2,1.2,1.2,1.2,1.2,0.0,1.2,0.0,
            1.2,1.2,1.2,1.2,1.2,1.2,1.2,1.2,1.2,0.0,0.0,
            0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
        ],
    }
)
# fmt: on
calc_params = dict(
    com_delta_diff_cty_rho_per_bucket_base=com_delta_diff_cty_rho_per_bucket_base,
    com_delta_gamma_low=com_delta_gamma_low,
)
print(calc_params)

request1 = dict(
    measures=[
        [&quot;Commodity DeltaCharge Low&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge Medium&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge High&quot;, &quot;scalar&quot;],
    ],
    groupby=[&quot;Group&quot;],
    hide_zeros=True,
    calc_params=calc_params,
)

result1 = ds.compute(request1)

# print(result1) #&lt;-- uncomment to see

request2 = dict(
    measures=[
        [&quot;Commodity DeltaCharge Low&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge Medium&quot;, &quot;scalar&quot;],
        [&quot;Commodity DeltaCharge High&quot;, &quot;scalar&quot;],
    ],
    groupby=[&quot;Group&quot;],
    hide_zeros=True,
)

result2 = ds.compute(request2)

# print(result2) #&lt;-- uncomment to see
print(result1)
print(result2)
</code></pre>
<h2 id="if-a-parameters-could-not-get-parsed"><a class="header" href="#if-a-parameters-could-not-get-parsed">If a parameters could not get parsed</a></h2>
<p>Currently, if your passed calc_param could not get parsed into a correct value (eg you provided float instead of a vector) - it will <strong>silently</strong> fall back to the defaulted value of the <code>jurisdiction</code>. <strong>This will be changed in the next release to return an error to avoid ambiguity</strong>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ui"><a class="header" href="#ui">UI</a></h1>
<p><strong><code>ultibi's</code></strong> provides a user friendly interface of your dataset and allows you to perform analysis live - without need to write any further code.</p>
<p><img src="./assets/ui.png" alt="ultibi ui" /></p>
<p>To achieve this simply call <strong><code>.ui()</code></strong> method on your dataset:</p>
<pre><code class="language-python">import ultibi as ul
import time
import os

os.environ[&quot;RUST_LOG&quot;] = &quot;info&quot;
os.environ[&quot;ADDRESS&quot;] = &quot;0.0.0.0:8000&quot;

start_time = time.time()
ds = ul.FRTBDataSet.from_config_path(&quot;./data/frtb/datasource_config.toml&quot;)
print(&quot;--- Read DF time: %s seconds ---&quot; % (time.time() - start_time))
ds.ui()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="performance"><a class="header" href="#performance">Performance</a></h1>
<p>ultibi FRTB aggregator was built with performance in mind. Bellow table summarizes a large Equity portfolio:</p>
<pre><code class="language-python">┌───────────┬──────────────┬────────────────┬───────────────┬──────────────┬─────────────────────┬─────────────────────┬─────────────────────────┐
│ RiskClass ┆ RiskCategory ┆ RiskFactorType ┆ TradeId_count ┆ PnL_Up_count ┆ BucketBCBS_n_unique ┆ RiskFactor_n_unique ┆ RiskFactorType_n_unique │
│ ---       ┆ ---          ┆ ---            ┆ ---           ┆ ---          ┆ ---                 ┆ ---                 ┆ ---                     │
│ str       ┆ str          ┆ str            ┆ u32           ┆ u32          ┆ u32                 ┆ u32                 ┆ u32                     │
╞═══════════╪══════════════╪════════════════╪═══════════════╪══════════════╪═════════════════════╪═════════════════════╪═════════════════════════╡
│ Equity    ┆ Delta        ┆ EqSpot         ┆ 648506        ┆ 648506       ┆ 4                   ┆ 18316               ┆ 1                       │
│ Equity    ┆ Delta        ┆ EqRepo         ┆ 219792        ┆ 219792       ┆ 3                   ┆ 18316               ┆ 1                       │
└───────────┴──────────────┴────────────────┴───────────────┴──────────────┴─────────────────────┴─────────────────────┴─────────────────────────┘
</code></pre>
<p>This portfolio consist of 868298 Equity Delta and Curvature (see PnL_Up_count) Sensitivities splic across 4 buckets, 18316 risk factors(equity names/tickers), with both Spot and Repo Present.</p>
<p>The result as of ultibi v0.1.3:
<strong>--- Read DF time: 483.5027ms ---</strong>
<strong>--- Assign Weights time: 1.1574655s ---</strong></p>
<p>Just single EQ Delta Charge:</p>
<pre><code class="language-python">request2 = dict(
    measures=[
        [&quot;EQ DeltaCharge Medium&quot;, &quot;scalar&quot;]
    ],
    # Break down results by Group and BucketBCBS
    groupby=[&quot;Group&quot;],

    # Show totals for each Group (note in this example only 1)
    totals = True,
    # Hide rows where each result is 0
    hide_zeros=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        # Apply 21.98
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
    },
)
</code></pre>
<p><strong>--- Compute time: 0.22789788246154785 seconds ---</strong></p>
<pre><code class="language-python">request2 = dict(
    measures=[
        [&quot;SBM Charge&quot;, &quot;scalar&quot;]
    ],
    # Break down results by Group and BucketBCBS
    groupby=[&quot;Group&quot;],

    # Show totals for each Group (note in this example only 1)
    totals = True,
    # Hide rows where each result is 0
    hide_zeros=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        # Apply 21.98
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
    },
)
</code></pre>
<p><strong>--- Compute No Deps time: 2.538625478744507 seconds ---</strong></p>
<h1 id="caching"><a class="header" href="#caching">Caching</a></h1>
<p>Note, thanks to <code>ultibi's</code> internal caching mechanism, basic measures can be reused. For example:</p>
<pre><code class="language-python">request = dict(
    measures=[
        [&quot;SBM Charge High&quot;, &quot;scalar&quot;],
        [&quot;SBM Charge Low&quot;, &quot;scalar&quot;],
        [&quot;SBM Charge Medium&quot;, &quot;scalar&quot;]
    ],
    # Break down results by Group and BucketBCBS
    groupby=[&quot;Group&quot;],

    # Show totals for each Group (note in this example only 1)
    totals = True,
    # Hide rows where each result is 0
    hide_zeros=True,
    calc_params={
        &quot;jurisdiction&quot;: &quot;BCBS&quot;,
        # Apply 21.98
        &quot;apply_fx_curv_div&quot;: &quot;true&quot;,
    },
)
</code></pre>
<p><strong>--- Compute No Deps time: 0.010367870330810547 seconds ---</strong></p>
<p>Compute time is almost identical to that of <code>request2</code>. This is because <code>SBM Charge</code> is a simple max of <code>SBM Charge Low</code>, <code>SBM Charge Medium</code>, <code>SBM Charge High</code> and therefore almost no additional compute is required.</p>
<p><strong>DataSet cache stores results of basic measures such as <code>EQ DeltaCharge Medium</code>. Therefore the next request will reuse them</strong>.</p>
<h1 id="standing-on-the-shoulders-of-a-giant-polars"><a class="header" href="#standing-on-the-shoulders-of-a-giant-polars">Standing on the shoulders of a giant: <code>Polars</code></a></h1>
<p>We use <code>Polars</code> in the backend, one of the fastest DataBase/DataFrame like ops solutions out there. Read more about the <a href="https://duckdblabs.github.io/db-benchmark/">benchmarks here</a> to get a feel for how much data we can process and how fast.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contacts-and-feedback"><a class="header" href="#contacts-and-feedback">Contacts and Feedback</a></h1>
<p><strong><code>ultibi</code></strong> was created by <strong><a href="https://ultimabi.uk/#">Ultima</a></strong></p>
<p>Get in touch:</p>
<ul>
<li><strong><a href="https://www.linkedin.com/company/91718551">LinkedIn</a></strong></li>
<li><strong><a href="https://www.linkedin.com/in/anatoly-bugakov-99670412a/">Anatoly's LinkedIn</a></strong></li>
<li><strong><a href="https://github.com/ultima-ib/ultibi-frtb-book">Github</a></strong></li>
<li>Raise an issue or PR: <strong><a href="https://github.com/ultima-ib/ultibi-frtb-book/issues">Github Issues</a></strong></li>
</ul>
<h1 id="start-us-on-github-ultima"><a class="header" href="#start-us-on-github-ultima">Start us on Github <a href="https://github.com/ultima-ib/ultibi-frtb-book">Ultima⭐</a></a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="tabbed-code-blocks.js"></script>

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
